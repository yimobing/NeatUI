<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="网站名称">
    <meta name="applicable-device" content="pc,mobile">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>Wechat | 微信聊天控件</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link type="text/css" rel="stylesheet" href="assets/neatui/css/neatui-wechat-test.css"><!--聊天控件-->
    <link type="text/css" rel="stylesheet" href="assets/neatui/css/neatui-form.css"><!--表单布局-->
    <link type="text/css" rel="stylesheet" href="assets/neatui/css/neatui-magnify.css"><!--图片放大预览控件(pc时)-->
    <link type="images/x-icon" rel="shortcut icon" href="/favicon.ico">
    <!--<script type="text/javascript" charset="gb2312" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script type="text/javascript" charset="gb2312" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>-->
    <script type="text/javascript" charset="gb2312" src="assets/libs/jweixin-1.2.0.js"></script>
    <script type="text/javascript" charset="gb2312" src="assets/libs/jweixin-1.0.0.js"></script>
    <script type="text/javascript">
        //ajax({})
        wx.config({
            debug: false,
            appId: '<%=s_corpId%>',
            timestamp: '<%=s_timestamp%>',
            nonceStr: '<%=s_nonceStr%>',
            signature: '<%=s_signature%>',
            jsApiList: [
                'scanQRCode',
                'checkJsApi',
                'chooseImage',
                'previewImage',
                'downloadImage',
                'getNetworkType',
                'openLocation',
                'getLocation',
                'uploadImage',
                'closeWindow'
            ]
        })
        wx.ready(function(){
            //测试
        })
    </script>
</head>
<body>
    <style>
        body{ max-width: 800px; margin: 0 auto; }
        .wrap{ padding: 15px 20px; }
        header{ margin: 15px auto; text-align: center; }
        h1{ color: #08ba61; }
        h3{margin: 20px auto 15px auto;  border-bottom: 3px solid #f25824; padding-bottom: 15px; }
        h3>span{ padding: 5px 10px; border: 2px solid #f25824; color: #f25824; border-radius: 4px; }
        main{ margin-top: 25px; }
    </style>

    <div class="wrap">
        <header>
            <h1>Wechat</h1>
            <h3>微信聊天控件</h3>
        </header>
        <main>
            <section class="grid-chat">
                <button type="button" id="btn-aside-touch">微信聊天</button>
            </section>
        </main>
    </div><!--/.wrap-->
    <!--================================================================================-->
    <!--                            JAVASCRIPT                                          -->
    <!--================================================================================-->
    <script type="text/javascript" src="assets/libs/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="assets/libs/bluebird.min.js"></script><!--pc时让ie支持promise-->
    <script type="text/javascript" src="assets/neatui/js/neatui-wechat-test.js"></script><!--聊天控件-->
    <script type="text/javascript" src="assets/neatui/js/neatui-magnify.js"></script><!--图片放大预览控件(pc时)-->
    <script type="text/javascript" src="assets/neatui/js/neatui-ajax.js"></script><!--自定义ajax-->
    <script type="text/javascript">
        /*+----------------全局变量----------------+*/
        // 全局变量 ajax({})
        var g_xjdh = '<%=s_xjdh%>';
        var g_dyw_xh = '<%=s_dyw_xh%>';

        //=====在线沟通
        var g_chat_pagesize = 10; // 聊天翻页每页记录数
        var g_chat_start_date = ''; // 聊天历史消息时间(聊天开始时间), 默认空
        var g_chat_latest_date = ''; // 聊天最新消息时间, 默认为第一次调用聊天历史消息时间
        var g_chat_history_times = 0; // 聊天历史消息调用的次数,默认0次

        /*+————————————————FUNCTION————————————————+*/
        /**
         * 获取用户数据
         * @returns {object} 返回一维数组
         */
        function get_data_user(){
            // 后台返回
            var json = {
                "return":"ok", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生"
            }
            /*
            // START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取聊天当前用户数据",
                debug: false,
                type: "POST",
                url: "../../fwh_pub/jk_pic_chat.ashx",
                data: {
                    "action": "sel_v2_xjd_chat_user_msgs",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk %>",
                    "user_bh": "<%=s_user%>"
                },
                success: function(res){
                    if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    // if(res == '') return;
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            // END AJAX
            */
            return json;
        }




        /**
         * 获取抵押物信息
         * @returns {object} 返回一维数组
         */
        function get_data_pawn(){
            // 后台返回
            var json = { "return":"ok", "bank_mc":"中国建设银行股份有限公司泉州分公司", "dyw_add":"1、住宅/泉州万科城（一期）/1号楼/2/201/126.09平方米/已满2年"}
            /*
            // START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取聊天抵押物数据",
                debug: false,
                type: "POST",
                url: "../../fwh_pub/jk_pic_chat.ashx",
                data: {
                    "action": "sel_v2_xjd_chat_dyw_add",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk %>",
                    "xjdh": g_xjdh,
                    "dyw_xh": g_dyw_xh
                },
                success: function(res){
                    if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    //if(res == '') return;
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            // END AJAX
            */
            return json;
        }


        /**
         * 获取聊天历史消息
         * @param {number} ps_nowpage 当前页码,默认1(可选)
         * @returns {object} 返回数组对象
         */
        function get_data_chat_history(ps_nowpage){
            if(g_chat_history_times == 0) g_chat_history_times = 1;
            else g_chat_history_times = 2;
            var ls_open_page_num = ps_nowpage; // 当前页码
            var ls_every_page_count = g_chat_pagesize; // 每页记录数
            // 后台返回
            var chatHistoryJson = {
                "return":"ok", "time":"2021-04-07 21:42:38", "data":[
                    {"chat_bh":"C1001", "user_hm":"U1001", "user_tx":"assets/neatui/img/wechat_avatar_male.png", "user_xm":"张三", "value1":"这个话很牛b", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1002", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"看你们聊得很开心", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1003", "user_hm":"U1001", "user_tx":"assets/neatui/img/wechat_avatar_male.png", "user_xm":"张三", "value1":"哪能这样说呢", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1004", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"看你们聊得很开心", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1005", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"test//img/img_purple.png", "value2":"", "check_word":"0", "check_voice":"0", "check_pic":"1", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1006", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"您看这个可以吗，帮我掌掌眼", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                    {"chat_bh":"C1007", "user_hm":"U1001", "user_tx":"assets/neatui/img/wechat_avatar_male.png", "user_xm":"张三", "value1":"这个设计不错，让设计部的同事都过来学习下", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"}
                ]
            }
        
            /*
            // START AJAX
            var chatHistoryJson = {}
            var isHoldOn = true;
            ajax({
                heading: "获取聊天历史消息",
                debug: false,
                type: "POST",
                url: "../../fwh_pub/jk_pic_chat.ashx",
                data: {
                    "action": "sel_v2_xjd_chat_lssj",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk %>",
                    "open_page_num": ls_open_page_num, // 当前页码
                    "every_page_count": ls_every_page_count, // 每页记录数
                    "xjdh": g_xjdh,
                    "dyw_xh": g_dyw_xh,
                    "time": g_chat_start_date
                },
                success: function(res){
                    if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    //if(res == '') return;
                    chatHistoryJson = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {};
            }
            // END AJAX
            */
            var ls_time = chatHistoryJson["time"];
            //全局赋值
            g_chat_start_date = ls_time; 
            if(g_chat_history_times == 1) g_chat_latest_date = ls_time;

            return chatHistoryJson;
        }
    

        /**
         * 获取聊天最新消息
         * @returns {object | promise} 返回数组对象或返回Promise对象
         */
        function get_data_chat_news(){

            // ①.同步时返回Object对象
            // // 后台返回
            // var chatNewlyJson = {
            //     "return":"ok", "time":"2021-04-09 18:55:32", "data":[
            //         {"chat_bh":"C1001", "user_hm":"U1001", "user_tx":"assets/neatui/img/wechat_avatar_male.png", "user_xm":"张三", "value1":"很无聊啊现在", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
            //         {"chat_bh":"C1002", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"这个进度还可以啦", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"}
            //     ]
            // }
            // /*
            // // START AJAX
            // var chatNewlyJson = {}
            // var isHoldOn = true;
            // ajax({
            //     heading: "获取聊天最新消息",
            //     debug: false,
            //     type: "POST",
            //     async: false, // false 同步取数, true 异步取数
            //     url: "../../fwh_pub/jk_pic_chat.ashx",
            //     data: {
            //         "action": "sel_v2_xjd_chat_new",
            //         "user": "<%=s_user%>",
            //         "sjk": "<%=s_sjk %>",
            //         "xjdh": g_xjdh,
            //         "dyw_xh": g_dyw_xh,
            //         "time": g_chat_latest_date
            //     },
            //     success: function(res){
            //         if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
            //         //if(res == '') return;
            //         chatNewlyJson = JSON.parse(res);
            //     },
            //     error: function(res){
            //         if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
            //     },
            //     beforeSend: function(XMLHttpRequest){ },
            //     complete: function(XMLHttpRequest, textStatus){ }
            // })
            // if(!isHoldOn){
            //     return {};
            // }
            // // END AJAX
            // */
            // g_chat_latest_date = chatNewlyJson["time"];   // 全局赋值
            // return chatNewlyJson;

            //②. 异步时返回Promise对象
            return new Promise(function(resolve, reject){
                // · 前台模拟异步
                setTimeout(function(){
                    var chatNewlyJson = {
                        "return":"ok", "time":"2021-04-09 18:55:32", "data":[
                            {"chat_bh":"C1001", "user_hm":"U1001", "user_tx":"assets/neatui/img/wechat_avatar_male.png", "user_xm":"张三", "value1":"很无聊啊现在", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"},
                            {"chat_bh":"C1002", "user_hm":"U1002", "user_tx":"assets/neatui/img/wechat_avatar_female.png", "user_xm":"小生", "value1":"这个进度还可以啦", "value2":"", "check_word":"1", "check_voice":"0", "check_pic":"0", "create_time":"2020-12-31 14:52:17"}
                        ]
                    }
                    resolve(chatNewlyJson);  // 成功，使用resolve()返回所有数据
                    // reject('ERROR，连接错误！'); // 错误，使用reject返回错误信息
                }, 2000)

                // ·后台返回
                /*
                // START AJAX
                var chatNewlyJson = {}
                var isHoldOn = true;
                ajax({
                    heading: "获取聊天最新消息",
                    debug: false,
                    type: "POST",
                    async: true, // false 同步取数, true 异步取数
                    url: "../../fwh_pub/jk_pic_chat.ashx",
                    data: {
                        "action": "sel_v2_xjd_chat_new",
                        "user": "<%=s_user%>",
                        "sjk": "<%=s_sjk %>",
                        "xjdh": g_xjdh,
                        "dyw_xh": g_dyw_xh,
                        "time": g_chat_latest_date
                    },
                    success: function(res){
                        if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                        //if(res == '') return;
                        chatNewlyJson = JSON.parse(res);
                        g_chat_latest_date = chatNewlyJson["time"]; // 全局赋值
                        resolve(chatNewlyJson); // 成功，使用resolve()返回所有数据
                    },
                    error: function(res){
                        if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                        reject('ERROR，连接错误！'); // 错误，使用reject返回错误信息
                    },
                    beforeSend: function(XMLHttpRequest){ },
                    complete: function(XMLHttpRequest, textStatus){ }
                })
                if(!isHoldOn){
                    return {}
                }
                // END AJAX
                */
            })
            
        }

        
        //——————————————————————————————————————————
        /**
         * 校验是否pc端 add 20211105-1
         */
         var isDevicePc =  function(){
            var userAgentInfo = navigator.userAgent.toLowerCase();
            //console.log(userAgentInfo);
            var Agents = ["mobile","android","iphone","sysbian","windows phone","iPad","ipod","blackberry"];
            var flag = false;
            for(var i=0; i<Agents.length; i++){
                if(userAgentInfo.indexOf(Agents[i])>=0){
                    flag = true;
                    break;
                }
            }
            return flag ? false : true;
        }


        /**
        * 检测ie版本号 add 20211105-1
        * @returns {number|string} 若是ie浏览器则返回对应版本号(整数), 否则返回一段文字
        */
        var checkIesVersion = function(){
            var userAgent = navigator.userAgent; //取得浏览器的userAgent字符串 
            var isIE = window.ActiveXObject || "ActiveXObject" in window;
            if (isIE)  
            { 
                var reIE = new RegExp("MSIE (\\d+\\.\\d+);"); 
                reIE.test(userAgent); 
                var banben = parseFloat(RegExp["$1"]); 
                if(userAgent.indexOf('MSIE 6.0')!=-1){
                    return 6;
                }else if(banben == 7){ 
                    return 7; //ie7或ie5
                }else if(banben == 8){ 
                    return 8;
                }else if(banben == 9){ 
                    return 9;
                }else if(banben == 10){ 
                    return 10;
                } else if(userAgent.toLowerCase().match(/rv:([\d.]+)\) like gecko/)){ 
                    return 11;
                }else{ 
                    return 0; //IE版本过低(ie5以下版本)
                }
            }else{
                return '抱歉，不是IE浏览器，无法检测IE版本';
            } 
        }
        
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $(function(){
            //————————————————————————————————————————————————————————————————————————————————————————————————
            //                                             START 微信聊天窗口
            //————————————————————————————————————————————————————————————————————————————————————————————————
            //——————————————————————————————————————————
            //=====检测IE版本，如果太低，则中断执行 add 20211105-1
            var ieVersion = parseInt(checkIesVersion());
            if(isNaN(ieVersion)) ieVersion = -1;
            // console.log('版本：', ieVersion);
            if(ieVersion > 0 && ieVersion <= 8){
                alert('对不起，你正在使用老掉牙的IE' + ieVersion + '浏览器，请升级至IE9以上版本');
                return;
            }

            
            //——————————————————————————————————————————
            //=====微信聊天窗口按钮 
            $('#btn-aside-touch').on('click', function(){
                var chatUserJson = get_data_user(); // 获取聊天当前用户数据
                var pawnJson = get_data_pawn(); // 获取抵押物信息
                var ls_xjdh = g_xjdh,
                    ls_dyw_add = pawnJson["dyw_add"],
                    ls_bank_mc = pawnJson["bank_mc"];
                // · 1、创建顶部信息
                var _topHtml = [
                    '<div class="collateral" style="margin-top: 10px; padding: 0 5px; font-size: 12px">',
                        '<div class="collateral___info">',
                            '<div class="eform-row">',
                                '<div class="item-l" style="width: 0; margin-right: 0; padding-left: 0;"><label style="width: 0"></label></div>',
                                '<div class="item-r"><span style="text-align: left">' + ls_bank_mc + '</span></div>',
                            '</div>',
                            '<div class="eform-row" style="display: none">',
                                '<div class="item-l" style="width: auto"><label>询价单号：</label></div>',
                                '<div class="item-r"><span>' + ls_xjdh + '</span></div>',
                            '</div>',
                            '<div class="eform-row flex-start">',
                                '<div class="item-l" style="width: auto"><label>抵押物信息：</label></div>',
                                '<div class="item-r"><span>' + ls_dyw_add + '</span></div>',
                            '</div>',
                        '</div><!--/.collateral___info-->',
                    '</div><!--/.collateral-->',
                ].join('\r\n');


                // 2、调用聊天控件
                $(this).neuiWechat({
                    aside: { // 侧栏窗口参数
                        // 前台提供的变量
                        caption: "在线沟通", // 标题,可自定义HTML(可选)
                        toper: _topHtml, //顶部,自定义HTML(可选).
                        cross: true, //是否显示关闭图标(可选),默认false
                        back: true, //是否显示返回按钮(可选),默认false
                        showBackText: false, // 是否显示返回按钮的文字(可选),默认true
                        capWrap: false, //标题是否单独一行(可选),默认true. 值为false时,标题将与顶部的关闭、返回按钮在同一行
                        isPcImage: true, // 是否要同时在pc端使用图片上传功能(可选),默认false。 true时上传图片将使用pc方式。记得引用相应的控件。add 20230519-1
                        // zIndex: 999 // 层级,默认999(可选)
                        offset: { // add 20211105-1
                            left: isDevicePc() ? ($(window).width() - 400) / 2 : 0,
                            right: isDevicePc() ? ($(window).width() - 400) / 2 : 0,
                            top: 0,
                            bottom: 0
                        }
                    },
                    roll: { // 上拉滚动参数
                        // 前台提供的变量
                        // 注①：当 autoLoad=true, cleanUp=true 时, 则：页面一打开就会清空滑动区域已有数据,且马上加载第1页数据
                        autoLoad: true, // 是否自动加载数据,默认true(可选).
                        cleanUp: false, // 是否先清空滑动区域已有数据,默认true(可选). true时只对第1页有效
                        pagesize: 7, // 每页记录数,默认20(可选).
                        delay: 500, // 转圈延迟时间,单位:毫秒(可选),默认0。本地调试用，只为看到转圈效果. 
                        threshold: 50, //预加载距离,即提前加载距离(可选).
                        getData: function(e){  // 前台获取并返回数据源. 参数e为当前页码等组成的一维对象
                            var nowpage = e.curpage
                            // console.log('当前页码：', nowpage);
                            return get_data_chat_history(nowpage);
                        }
                    },
                    source: { // 数据源
                        user: { // 当前用户信息 ajax({})
                            identifier: chatUserJson["user_hm"], // 用户号或用户标识,默认空
                            surname: chatUserJson["user_xm"], // 用户姓名或昵称,默认空
                            profile: chatUserJson["user_tx"] // 用户头像,默认空
                        },
                        field: { // 自定义字段格式(可选)
                            // 主键
                            keys: "chat_bh", // 记录主键
                            // 用户
                            avatar: "user_tx", // 用户头像
                            userNo: "user_hm", //用户编号
                            userName: "user_xm", // 用户姓名或昵称
                            // 消息类型
                            checkWord: "check_word", // 消息类型是否炒文字
                            checkPhoto: "check_pic", // 消息类型是否为图片
                            checkVoice: "check_voice", // 消息类型是否为语音
                            // 消息内容
                            value: "value1", // 内容. 消息类型为文本时
                            thumb: "value1",  // 小图. 消息类型为图片时
                            picture: "value2", // 大图. 消息类型为图片时
                            // 日期
                            date: "create_time" // 聊天时间
                        }, 
                    },
                    enableVoice: false, // 是否启用语音,默认true(可选)
                    enablePolling: false, // 是否启用轮询,即启用定时器,默认true(可选)
                    intervals: 5, // 消息定时器时长,默认5,单位：秒(可选).
                    bubbleMsg: 50, // 若有新消息，滚动条距离底部多远显示新消息数量,默认50px(可选).
                    inputMinHeight: 32, // 输入框最小高度,默认32(可选).
			        inputMaxHeight: 100, // 输入框最大高度,默认32(可选).
                    alwaysShowSend: true, // 是否一直显示发送区, 默认false(可选).
                    events: { // 系列事件. 须返回操作结果给控件. ajax({})
                        send: function(e){  // 发送消息按钮. e 格式 {type:"消息类型", content:"消息内容"}. type值：word 文字, voice 语音
                            //console.log('发送消息e:', e);
                            var ls_type = e.type; // 消息类型
                            var ls_value = e.content; // 消息内容
                            //开始执行
                            var flag = '', msg = '消息发送成功';
                            //后台返回
                            /*
                            // START AJAX
                            var isHoldOn = true;
                            ajax({
                                heading: "发送文字聊天消息(保存询价单聊天表)",
                                debug: false,
                                type: "POST",
                                url: "../../fwh_pub/jk_pic_chat.ashx",
                                data: {
                                    "action": "save_v2_xjd_chat",
                                    "user": "<%=s_user%>",
                                    "sjk": "<%=s_sjk %>",
                                    "user_bh": "<%=s_user%>",
                                    "xjdh": g_xjdh,
                                    "dyw_xh": g_dyw_xh,
                                    "value": ls_value
                                },
                                success: function(res){
                                    if(res == '') return;
                                    var json = JSON.parse(res);
                                    flag = json.result == 'ok' ? 1 : 0;
                                    if(!flag) msg = json.result;
                                },
                                error: function(res){
                                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                                },
                                beforeSend: function(XMLHttpRequest){ },
                                complete: function(XMLHttpRequest, textStatus){ }
                            })
                            if(!isHoldOn){
                                neui.destroyAnimate();
                                return;
                            }
                            // END AJAX
                            */
                            flag = parseInt(1); //1 成功, 0 失败
                            if(!flag) msg = '消息发送失败';
                            
                            return flag ? 'ok' : 'error'; // ok 成功, error 失败
                        },
                        getNews: function(){  // 获取最新消息. 注意：返回格式为Object对象或Promise对象, 即若AJAX为同步则返回消息数据Object一维对象; 若AJAX为异步,则返回消息数据写在resolve()中的Promise对象
                            return get_data_chat_news();
                        },     
                        album: function(){ // 相册图片, 返回给控件单张或多张图片(小图、大图组成的对象). 注意：返回的是promise对象
                            //alert('点我开始上传图片');
                            // 返回小图、大图组成的对象. 可1张或多张图片
                            /*  
                                var ls_pic_url = 'test//img/img_blue.png', // 小图
                                    ls_pic_url_big = 'test//img/img_blue.png'; // 大图
                                // ①. 返回单张图片
                                // return {thumb: ls_pic_url, picture: ls_pic_url_big};
                                // ②.返回多张图片
                                return {data:[{thumb: ls_pic_url, picture: ls_pic_url_big}, {thumb: ls_pic_url, picture: ls_pic_url_big} ] }
                            */
                            return fnChatUploadPicture(); // 因实际图片上传调用微信接口会存在延迟，故需使用promise解决异步问题
                        }
                    }
                })
            });




            //——————————————————————————————————————————
            /**
             * 微信聊天上传图片操作
             */
            function fnChatUploadPicture(){
                var allImgJson = {data:[]} // 这个要放外面,若放内部,则会出现undefined情况(把setTimeout去掉时)
                return new Promise(function(resolve, reject){
                    // · 后台实际操作
                    // 后台返回
                    /*
                    // --------START 开始图片上传--------
                    var isContinue = true;
                    var localIds, li_count, up_i;
                    var i;
                    var u = navigator.userAgent, app = navigator.appVersion,
                        isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1,
                        isIos = !!u.match(/\(i[^;]+;( u;)? CPU.+Mac OS X/);
                    // isIos = true;

                    // ①.start android 安卓端
                    if(isIos == false){
                        parent.parent.parent.parent.parent.wx.chooseImage({
                            sizeType: ['original', 'compressed'],
                            sourceType: ['album', 'camera'],
                            success: function(res){
                                localIds = res.localIds;
                                li_count = res.localIds.length;
                                if(li_count > 0){
                                    neuiDialog.alert({
                                        animate: true,
                                        message: '您确定要上传(' + li_count.toString() + ')张图片吗？',
                                        buttons: ['确定', '取消'],
                                        zIndex: 1000, // 自定义遮罩层级
                                        callBack: function(ret){
                                            if(ret == 1){
                                                up_i = 0;
                                                for(i = 0; i < li_count; i++){
                                                    parent.parent.parent.parent.parent.wx.uploadImage({
                                                        localId: localIds[i],
                                                        isShowProgressTips: 1,
                                                        success: function(res){
                                                            var serverId = res.serverId;
                                                            up_i = up_i + 1;
                                                            $.ajax({
                                                                async: false, // 取数方式. true 异步(默认), false 同步
                                                                type: "POST",
                                                                dataType: "html",
                                                                cache: false,
                                                                url: "../../fwh_pub/jk_pic_chat.ashx",
                                                                data: {
                                                                    "action": "uploadImage_chat_pic",
                                                                    "user": "<%=s_user%>",
                                                                    "sjk": "<%=s_sjk%>",
                                                                    "serverId": serverId,
                                                                    "localId": localIds[up_i - 1],
                                                                    "li_count": li_count.toString(),
                                                                    "up_i": up_i.toString(),
                                                                    "user_bh": "<%=s_user%>",
                                                                    "xjdh": g_xjdh,
                                                                    "dyw_xh": g_dyw_xh
                                                                },
                                                                success: function(res){
                                                                    sendOneImageToUser(res, li_count);
                                                                },
                                                                error: function(res){ },
                                                                beforeSend: function(XMLHttpRequest){ },
                                                                complete: function(XMLHttpRequest, textStatus){ }
                                                            })

                                                            if(up_i == li_count){ 
                                                                //..
                                                            }
                                                        },
                                                        fail: function(res){
                                                            reject("图片上传失败，请重试");
                                                            isContinue = false;
                                                        },
                                                        complete: function(res){ }
                                                    })
                                                } // FOR
                                                // if(confirm('您确定要上传(' + li_count.toString() + ')张图片吗？')) { }
                                            } // RET
                                        } // CALLBACK
                                    })
                                } // IF
                            }
                        })
                    }
                    // end android 安卓端

                    // ②.start ios/iphone 苹果端
                    if(isIos == true){
                        parent.parent.parent.parent.parent.wx.chooseImage({
                            sizeType: ['original', 'compressed'],
                            sourceType: ['album', 'camera'],
                            success: function(res){
                                localIds = res.localIds;
                                li_count = res.localIds.length;
                                if(li_count > 0){
                                    neuiDialog.alert({
                                        animate: true,
                                        message: '您确定要上传(' + li_count.toString() + ')张图片吗？',
                                        buttons: ['确定', '取消'],
                                        zIndex: 1000, // 自定义遮罩层级
                                        callBack: function(ret){
                                            if(ret == 1){
                                                aabbcc();
                                            }
                                        }
                                    })
                                }
                            },
                            fail: function(res){ },
                            complete: function(res){ }
                        });
                        i = 0;
                        var aabbcc = function(){
                            if(i < li_count){
                                parent.parent.parent.parent.parent.wx.uploadImage({
                                    localId: localIds[i],
                                    isShowProgressTips: 1,
                                    success: function(res){
                                        var serverId = res.serverId;
                                        $.ajax({
                                            async: false, // 取数方式. true 异步(默认), false 同步
                                            type: "POST",
                                            dataType: "html",
                                            cache: false,
                                            url: "../../fwh_pub/jk_pic_chat.ashx",
                                            data: {
                                                "action": "uploadImage_chat_pic",
                                                "user": "<%=s_user%>",
                                                "sjk": "<%=s_sjk%>",
                                                "serverId": serverId,
                                                "localId": localIds[i],
                                                "li_count": li_count.toString(),
                                                "up_i": i.toString(),
                                                "user_bh": "<%=s_user%>",
                                                "xjdh": g_xjdh,
                                                "dyw_xh": g_dyw_xh
                                            },
                                            success: function(res){
                                                sendOneImageToUser(res, li_count);
                                            },
                                            error: function(res){ },
                                            beforeSend: function(XMLHttpRequest){ },
                                            complete: function(XMLHttpRequest, textStatus){ }
                                        })
                                        i = i + 1;
                                        if(i == li_count){
                                            // location.reload(true);
                                        }
                                        aabbcc();
                                    },
                                    fail: function(res){
                                        reject("图片上传失败，请重试");
                                        isContinue = false;
                                    }
                                })
                            }
                        }
                    }
                    // end ios/iphone 苹果端

                    if(isContinue == true){
                        // alert('上传成功');
                    }
                    // --------END 结束图片上传--------
                    */


                    // · 前台模拟操作(生产环境下请注释掉本段代码)
                    setTimeout(function(){ // 模拟异步
                        var countPic = 2; // 总计N张图片
                        for(var i = 0; i < countPic; i++){
                            if(i == 0)
                                var oneImgJson = {
                                    data:[
                                        {"pic_bh":"1001", "pic_url":"test//img/img_gray.png", "pic_url_big":"test//img/img_blue.png"}
                                    ]
                                }
                            if(i == 1)
                                var oneImgJson = {
                                    data:[
                                        {"pic_bh":"1001", "pic_url":"test//img/img_blue.png", "pic_url_big":"test//img/img_gray.png"},
                                        //{"pic_bh":"1001", "pic_url":"test//img/img_blue.png", "pic_url_big":""}
                                    ]
                                }
                            sendOneImageToUser(JSON.stringify(oneImgJson), countPic);
                        }
                    }, 1000)


                    // ·发送单张图片给用户
                    // @param {string} msg 一维对象字符串
                    // @param {number} total 图片总数
                    function sendOneImageToUser(msg, total){
                        var isGoOn = true;
                        var errors = '';
                        if(msg == ''){
                            errors = '图片为空1';
                            isGoOn = false;
                        }
                        var json = {}
                        if(isGoOn) json = JSON.parse(msg);
                        if(isGoOn && $.isEmptyObject(json)){
                            errors = '图片为空2';
                            isGoOn = false;
                        }
                        if(isGoOn && typeof json.data == 'undefined'){
                            errors = '图片不含data属性';
                            isGoOn = false;
                        }
                        if(isGoOn && json.data.length == 0){
                            errors = '图片data为空';
                        }
                        if(errors != ''){
                            reject('上传后返回的信息有误：' + errors); // 错误，使用reject返回错误信息
                        }else{
                            var source = json.data[0];
                            var ls_pic_url = source["pic_url"],
                                ls_pic_url_big = source["pic_url_big"];
                            var imgJson = {thumb: ls_pic_url, picture: ls_pic_url_big}
                            allImgJson.data.push(imgJson);
                        }
                        if(allImgJson.data.length == total) resolve(allImgJson);  // 成功，使用resolve()返回所有图片数据
                    }

                }) // END PROMISE
            }

            
        }); //$(function(){});

    </script>
</body>
</html>