<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="网站名称">
    <meta name="applicable-device" content="pc,mobile">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>测试1</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link type="text/css" rel="stylesheet" href="assets/neatui/css/neatui-dialog.css">
    <link type="text/css" rel="stylesheet" href="assets/neatui/css/neatui-uploadFile.css">
</head>
<body>

    <h1>文件上传功能</h1>
    <h5>
        <pre>
            参考：
            1. jQuery ajax xhr文件上传进度条监听 
            https://blog.csdn.net/qq_36509946/article/details/95447892
            2.批量上传时xhr.upload.addEventListener进度的坑：
            https://www.cnblogs.com/ray-h/p/12360419.html
        </pre>
    </h5>
    

    <hr>
    <div class="wrap">
        <div id="app"></div>
    </div><!--/.wrap-->


    <!--================================================================================-->
    <!--                            JAVASCRIPT                                          -->
    <!--================================================================================-->
    <script src="assets/libs/jquery-1.8.3.min.js"></script>
    <script src="assets/libs/axios.min.js"></script>
    <script src="assets/neatui/js/neatui-dialog.js"></script>
    <script src="assets/neatui/js/neatui-uploadFile.js"></script>
    <!--模拟数据 test1-->
    <script src="assets/mock/mock-min.js"></script>
    <script >
        /*+————————————————全局变量————————————————+*/
    
        /*+————————————————FUNCTION————————————————+*/
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $(function(){
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //+                                                          初始化                                                 
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //——————————————————————————————————————————
            // 模拟数据 test1
            // Mock.setup({
            //     timeout: '100-1000', // 延时n-m毫秒
            // });
            // Mock.mock("../../../file/file_pdf.ashx", "post", (v) => {
            //     console.log('后台参数：', v);
            //     // var source = JSON.parse(v.body);
            //     var result = {return: "ok", data: "ok"}
            //     // var result = {return: "error", data: "上传失败，原因不明"}
            //     return JSON.stringify(result);
            // });


            


    
            
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //+                                                         系列事件                                             
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //——————————————————————————————————————————
            // 加载控件
            var neUps = new NeUploadFile(); // 实例化
            // 1.初始化
            neUps.init('#app', {
                enable: true, // 是否启用上传功能(可选)，默认true
                fileType: ['png', 'gif', 'jpg', 'jpeg'], // 文件类型限制(必须)，默认空。
                fileSize: 500, // 文件大小限制，单位kb(可选)，默认500kb
                multiple: true, // 是否允许使用批量上传功能(可选)，默认true
                width: '800px', // 区域宽度，默认单位为px(可选)，默认800px。可传像素值500表示500px，或传百分比'50%'

                chooseButtonLabel: '选择文件', // 选择文件按钮的显示文字(可选)，默认'选择文件'
                upButtonLabel: '开始上传', // 上传按钮的显示文字(可选)，默认'开始上传'
                suggestionLabel: '只能上传jpg/png文件，且不超过500kb', // 建议信息(可选)
                successLabel: '上传成功', // 上传成功后显示的提示文字(可选)，默认上传成功

                showThumb: false, // 是否显示缩略图(可选)，默认true
                showSize: true, // 是否显示文件大小(可选)，默认true
                showProgress: true, // 是否显示进度条(可选)，默认true
                showCross: true, // 是否显示打叉图标用以删除当前文件(可选)，默认true

                overflow: 'auto', // 上传文件列表如果超过一屏，是否显示滚动条(可选)，默认auto。值：auto 使用浏览器的滚动条, scroll 使用区区域的滚动条(可本区域显示自己的滚动条)
        
                form: { // 上传区域表单功能(可选)
                    // 内置表单
                    enable: false, // 是否启用内置表单功能(可选)，默认true
                    valid: true, // 点上传按钮是内置表单是否必填(可选)，默认true
                    label: '案件编号', // 内置表单的文本(可选)，默认'文件名'
                    placeholder: '请填写案件编号', // 内置表单输入框的placeholder属性值(可选)，默认true
                    // 外置表单，即自定义表单
                    customHTML: '' // 外置表单(可选)，非空时内置表单功能将不起作用
                },
                callBack: function(e){ // 回调
                    // console.log('e：', e);
                    // if(fnRunCheck(e)){
                    //     fnRunUpload(e);
                    // }

                    // fnRunUpload(e);

                    var files = e.files; // 文件列表
                    var asyncFun = [];
                    for(var i = 0; i < files.length; i++){
                        var file = files[i];
                        var ls_pdf_mc = file.name;
                        var result = fnLoopCheck(ls_pdf_mc);
                        asyncFun.push(result);
                    }
                    Promise.all(asyncFun).then(res => {
                        console.log('res：', res);
                        fnRunUpload(e);
                    }).catch(errs => {
                        neuiDialog.alert({
                            animate: true,
                            message: errs,
                            buttons: ['确定']
                        });
                    });
                }
            });

            

            /**
             * !! 校验pdf文件是否存在
             * @param {object} e 控件回调事件对象 
             * @returns {boolean} 返回布尔值。true 已存在, false 不存在
             */
            function fnRunCheck(e){
                // var isContinue = true;
                // var files = e.files; // 文件列表
                // var data = [];
                // for(var i = 0; i < files.length; i++){
                //     var file = files[i];
                //     var ls_pdf_mc = file.name;
                //     var result = fnLoopCheck(ls_pdf_mc);
                //     data.push(result);
                // }
                // Promise.all(data).then(res => {

                // }).catch(errs => {
                //     // console.log('errs:', errs)
                // })
            }

            // 模拟数据 test2
            Mock.setup({
                timeout: '100-1000', // 延时n-m毫秒
            });
            Mock.mock("../../../falv_jk/jk_anjian/jk_anjian_pdf.ashx", "post", (v) => {
                // console.log('后台参数：', v);
                // var source = JSON.parse(v.body);
                var result = {return:"ok", data:"0"}
                return result;
            });

            var fnLoopCheck = function(ps_pdf_mc){
                return new Promise(function(resolve, reject){
                    axios.post("../../../falv_jk/jk_anjian/jk_anjian_pdf.ashx", {
                        "action": "wh_anjian_pdf_exist",
                        "user": "<%=s_user%>",
                        "sjk": "<%=s_sjk%>",
                        "menu_bh": "<%=s_menu_bh%>",
                        "pdf_mc": ps_pdf_mc
                    }).then(res => {
                        // console.log('res：', res);
                        let source = res.data;
                        if(source.return == 'ok'){
                            if(source.data == '1'){ // 1 已存在PDF文件, 0 不存在PDF文件
                                reject('系统中已存在名称为【' + ps_pdf_mc + '】的PDF文件，请勿重复上传！');
                            }
                            else{
                                resolve('ok');
                            }
                        }
                        else{
                            reject(source.data);
                        }
                        
                    }).catch(errs => {
                        reject('判断是否存在PDF文件的接口出错了');
                    });
                });
            }


            //——————————————————————————————————————————
            // 
            /**
             * !! 文件上传事件
             * @param {object} e 控件回调事件对象
             */
             function fnRunUpload(e){
                var files = e.files, // 文件列表
                    fileData = e.fileData, // 表单数据
                    fileDom = e.fileDom, // 选择文件按钮DOM对象
                    uploadDom = e.uploadDom; // 上传文件按钮DOM对象
                // 循环执行
                var isAllRight = true; // 是否全部成功，默认true
                var failIndex = 0; // 失败的那个文件索引值
                for(let i = 0; i < files.length; i++){ // 这里要用let不用var，否则addEventListener('progress')监听事件的里传的循环i永远是最后一个循环的数
                    var file = files[i];
                    var ls_lvshi_anhao = fileData[i].value[0];
                    // console.log('案号：', ls_lvshi_anhao);
                    var formData = new FormData();
                    formData.append("file", file);
                    formData.append("lvshi_an_hao", fileData[i].value);
                    // START AJAX
                    $.ajax({
                        url: "../../../file/file_pdf.ashx",
                        type: "POST",
                        data: formData,
                        xhr: function () {
                            var myXhr = $.ajaxSettings.xhr();
                            if (myXhr.upload) { // 检查属性是否存在
                                console.log('aaa'); // test1
                                // 绑定事件的回调函数
                                console.log('qqq：', myXhr.upload);
                                myXhr.upload.addEventListener('progress', function(e){
                                    console.log('bbb'); // test1
                                    progressHandlingFunction(e, i);
                                }, false);
                            }
                            return myXhr; // xhr对象返回给jq使用
                        },
                        processData: false, // 不处理发送的数据
                        contentType: false, // 不设置Content-Type请求头
                        success: function (res) {
                            // console.log('res：', res);
                            // 校验返回的数据格式
                            if (res == null || res == undefined || res == '') {
                                neuiDialog.alert({
                                    animate: true,
                                    message: '返回值格式有误！<br>返回值为：' + res,
                                    buttons: ['知道了']
                                });

                                isAllRight = false;
                                failIndex = i;
                                return;
                            }
                            // 数据格式正确时
                            var source = JSON.parse(res);
                            if(source.return != 'ok'){
                                var msg = source.data; // '上传失败，请重试！';
                                neuiDialog.alert({
                                    animate: true,
                                    message: msg,
                                    buttons: ['确定']
                                });
                                isAllRight = false;
                                failIndex = i;
                            }
                            
                        },
                        error: function(res){ },
                        beforeSend: function(XMLHttpRequest){ },
                        complete: function(XMLHttpRequest, textStatus){ }
                    });
                    // END AJAX

                    if(isAllRight == false) break; // 中断并跳出循环
                    
                } // for

                // 上传结果提示
                var msg = '上传成功';
                if(isAllRight == false){
                    msg = '第' + ( failIndex + 1) + '个文件上传失败！';
                    neUps.handleFail(failIndex); // 3.失败时
                }
                neuiDialog.alert({
                    animate: true,
                    message: msg,
                    buttons: ['确定']
                });
            }



            //——————————————————————————————————————————
            /**
             * !! 进度处理事件
             * @param {object} evt 监听事件对象
             * @param {Number} 当前正在上传的文件索引值
             */
            function progressHandlingFunction(evt, index){
                if(evt.lengthComputable){
                    var value = evt.loaded,
                        max = evt.total;
                    // console.log('index：', index, '\nvalue：', value, '\nmax：', max);
                    // console.log('-------------')
                    neUps.handleProgress(index, value, max); // 2. 处理中
                }
            }
            

            
        }); //$(function(){});
    </script>


</body>
</html>