<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="网站名称">
    <meta name="applicable-device" content="pc,mobile">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>在线沟通消息(pc版)</title>
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link type="text/css" rel="stylesheet" href="../assets/style/font-awesome/css/font-awesome.css"><!--图标库-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui.min.css"><!--前端框架-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui-dialog.css"><!--对话框-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui-calendar.css"><!--日历-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui-dropdown.css"><!--下拉联动控件-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui-form.css"><!--表单布局-->
    <link type="text/css" rel="stylesheet" href="../assets/neatui/css/neatui-loadmore.css"><!--上拉加载更多-->
    <link type="images/x-icon" rel="shortcut icon" href="/favicon.ico">
</head>
<body>
    <!--edit 20210518-1 20210518-2 20210518-3-->
    <style>
        body{width: 98.5%; max-width: 640px; margin: 0 auto; background-color: #f4f4f4; font-size: 16px; }
        *{margin: 0; padding: 0; box-sizing: border-box; -webkit-box-sizing: border-box; -moz-box-sizing: border-box; -moz-box-sizing: border-box; outline: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); -webkit-tap-highlight-color:rgba(0, 0, 0, 0); -webkit-text-size-adjust: none; } 
        *:not(input, textarea){-webkit-touch-callout: none; -webkit-user-select: none; }
        /*+----------------tab---------------+*/
        .tab{display: -webkit-box; display: -moz-box; display: -ms-flexbox; display: -webkit-flex; display: box; display: flex; margin-top: 12px; } 
        .tab>div{display: -webkit-box; display: -moz-box; display: -ms-flexbox; display: -webkit-flex; display: box; display: flex; align-items: center; justify-content: center; position: relative; width: 100%; height: 40px; background-color: #daf0fd; color: #4c626f; text-align: center; font-size: 15px; }
        .tab>div:first-child{border-radius: 8px 0 0 0; } 
        .tab>div:nth-child(2){border-radius: 0 8px 0 0; } 
        .tab>div.on{background-color: #fff; border-radius: 0; font-weight: bold; } 
        .tab>div.on:before{position: absolute; top: -5px; left: 0; content: ''; display: inline-block; width: 100%; height: 10px; background-color: #fff; } 
        .tab>div.on:after{content: ''; position: absolute; z-index: 1; top: 0; width: 0; height: 0; } 
        .tab>div:first-child.on:before{border-radius: 8px 20px 0 0; } 
        .tab>div:first-child.on:after{right: -40px; border-bottom: 40px solid #fff; border-right: 40px solid  transparent; } 
        .tab>div:nth-child(2).on:before{border-radius: 20px 8px 0 0; } 
        .tab>div:nth-child(2).on:after{left: -40px; border-bottom: 40px solid #fff; border-left: 40px solid transparent; }
        .tab__latest.has-border{ border-style: solid; border-color: #fff; border-width: 0 1px 0 1px; }
         /*+----------------search---------------+*/
         .search{ position: fixed; z-index: 1; top: 60px; right: 0px; padding: 10px 8px; text-align: right; color: #777; }
         .search button{ display: inline-block!important; width: 60px!important; padding: 0!important; background: none; border: 0; font-size: 13px; }
         .search button>i{ margin-right: 5px; font-size: 12px; }
         .block__searchBank{ border: 1px solid #f5f2f2; border-radius: 4px; }
         .searchBank__one{ position: relative; padding: 8px 12px; border-top: 1px solid #f5f2f2; align-items: center; }
         .searchBank__one:first-child{ border-top: 0; }
         /* .searchBank__one:after{ 
             content: ''; position: absolute; right: 8px; top: 50%; -webkit-transform: translateY(-50%); -moz-transform: translateY(-50%); -o-transform: translateY(-50%); transform: translateY(-50%); -webkit-transform: rotate(45deg); -moz-transform: rotate(45deg); -o-transform: rotate(45deg); transform: rotate(45deg); width: 6px; height: 6px; border-style: solid; border-color: #444; border-width: 1px 1px 0 0;
         } */
         .searchBank__text{ width: 100%; margin-right: 10px; flex: 1; -webkit-flex: 1; -moz-flex: 1; -o-flex: 1; font-size: 12px; }
         .searchBank__text span{ }
         .searchBank__text em{ margin-left: 5px; color: #F25E54; }
         .searchBank__operate{ width: auto; /*margin-right: 15px;*/ }
         .searchBank__operate button{ height: 26px; line-height: 26px; padding: 0 6px; font-size: 12px; }
         .searchBank__operate button i{ margin-right: 2px!important; font-size: 10px; }
         .panel__nodata{ padding: 12px 16px; text-align: center; color: #1b9af7; font-size: 14px; }
        /*+----------------history---------------+*/
        .history{ min-height: 25px; } 
        .history__one{ position: relative; margin-bottom: 15px; } 
        .history__one .eform-content{padding: 20px 10px 8px 25px; background-color: #fff; border-radius: 8px 8px 0 0; } 
        .history__one:first-child .eform-content{border-top-left-radius: 0; border-top-right-radius: 0; } 
        .history__one .eform-button{ margin-top: 1px; border-radius: 0 0 8px 8px;}
        .history__one .eform-button button{color: #759d89!important;}
        .history__one .eform-button button span+i{ margin-left: 5px; }
        .history__one .row__unreadPerson label, 
        .history__one .row__unreadPerson span{ color: #F25E54; font-weight: bold; }

        /*pc端时 add 20211013-1 20211013-2*/
        @media screen and (min-width: 640px){
            .search{ top: 50px;  right: calc((100% - 640px - 150px)/2); }
            .jedatebox{ left: calc((100% - 600px) / 2 + 100px)!important; }
            .ne-drop-down{ left: calc((100% - 570px) / 2)!important; }
        }
        .history__one .eform-button:hover,
        .history__one .eform-button button:hover{
            background: #fff!important;
            color: #759d89!important;
        }

    </style>

    <!-- add 20211013-1-->
    <!--[if IE]>
        <style>
            .tab>div{
                display: inline-block;
                width: 32.5%;
                line-height: 40px;
                cursor: default;
            }
            .eform-row{ }
            .eform-row .item-l,
            .eform-row .item-r{
                display: inline-block;
                *display: inline;
                _display: inline;
                *zoom: 1;
                vertical-align: top;
            }
            .eform-row .item-l{ width: 15%; margin-right: 2%; }
            .eform-row .item-r{ width: auto; max-width: 78%; }
            .ne-aside .as-lay-header.has-cap-nowrap .header-top-caption{ width: 80%; }
            .searchBank__text span{ font-size: 16px; }
            .searchBank__operate{ margin-top: 8px; }
            .ne-aside .as-lay-footer button[type="button"] +button{ width: 65%!important; }
        </style>
    <![endif]-->

    <div class="wrap"><!--edit 20210517-1-->
        <main>
            <section class="tab">
                <div class="tab__unread on">我的未读消息</div>
                <div class="tab__latest" style="display: none;">最近消息</div>
                <div class="tab__unreply" style="display: none;">未回复消息</div> 
            </section>
            <section class="history"></section>
        </main>
        <aside class="sidebar">
            <section class="search" style="display: none">
                <button type="button" class="ne-btn has-texture blue" id="btn-filter"><i class="fa fa-filter"></i><span>筛选</span></button>
            </section>
        </aside>
    </div><!--/.wrap-->


    <!--================================================================================-->
    <!--                            JAVASCRIPT                                          -->
    <!--================================================================================-->
    <script type="text/javascript" src="../assets/style/libs/jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="../assets/style/libs/bluebird.min.js"></script><!--ie支持promise--> <!--add 20211013-1-->
    <script type="text/javascript" src="../assets/neatui/js/neatui.min.js?v=20211013-1"></script><!--前端框架-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-dialog.js"></script><!--对话框-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-calendar.js"></script><!--日历-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-dropdown.js"></script><!--下拉联动控件-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-form.js"></script><!--表单布局-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-loadmore.js"></script><!--上拉加载更多-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-functions.js"></script><!--函数库-->
    <script type="text/javascript" src="../assets/neatui/js/neatui-ajax.js"></script><!--自定义AJAX-->
    <script type="text/javascript">
        /*+————————————————全局变量————————————————+*/
        // 常量
        var TABINDEX = 1; // 切片索引值+1. 1 未读消息(默认), 2 最新消息
        var ROOTNODE = '.history'; // 列表根节点
        var PAGESIZE = 20; // 每页记录数
        //全局变量 edit 20210517-1
        var g_check_manager = '1'; //'<%=s_check_gly%>'; // 是否管理员. 1 是, 0 否 ajax({})
        var g_pggs_bh = 'P1001'; //'<%=s_pggs_bh%>'; // 评估公司编号. 非空表示评估公司人员, 空时表示非评估公司人员 ajax({})


        // 默认值 add 20210515-1
        var defaultStartDate = ''; // calendar.getDay(-(3*365)); //开始日期. 默认三年前
        var defaultEndDate = ''; // calendar.getDay(0); //结束日期. 默认当天
        var defaultBankBh = '全部'; //银行编号默认值
        var defaultBankMc = '全部'; //银行名称默认值
        var defaultCateMc = '全部'; // 行别默认值 add 20210420-1
        // 搜索条件 add 20210515-1
        var g_rw_jc = ''; // 行别 
        var g_bank_bh = ''; // 银行编号
        var g_bank_mc = ''; // 银行名称
        var g_xjdh = ''; // 询价单号
        var g_xjr = ''; // 询价人
        var g_dyw = ''; // 抵押物
        var g_ksrq = ''; // 开始日期
        var g_jsrq = ''; // 结束日期

        /*+————————————————FUNCTION————————————————+*/
        /**
         * 获取聊天消息数据 edit 20210422-1
         * @param {number} ps_curpage 当前页码(可选),默认1
         * @returns {Promise} 返回第N页对应的Promise对象. 其中resolve(res)中的res为数据源
         */
        function get_data_message(ps_curpage){
            var ls_sjlb = TABINDEX,
                ls_open_page_num = typeof ps_curpage == 'undefined' ? 1 : ( isNaN(parseInt(ps_curpage)) ? 1 : (parseInt(ps_curpage)) );
                ls_every_page_count = PAGESIZE;
            return new Promise(function(resolve, reject){

                // · 前台模拟异步
                setTimeout(function(){
                    var json = {
                        "data":[
                            {"xjdh":"X1001", "dyw_xh":"D1001", "xjr":"张三", "dyw_add":"1、住宅/泉州万科城（一期）/1号楼/2/201/126平方米/已满2年", "jgmc":"中国建设银行股份有限公司泉州分公司", "check_user_kd":"1", "create_time":"2021-04-15 12:03:48", "wdr":"李逵"},
                            {"xjdh":"X1002", "dyw_xh":"D1001", "xjr":"李四", "dyw_add":"1、住宅/泉州星光耀广场（二期）/5号楼/10/1005/178平方米/已满2年", "jgmc":"中国建设银行股份有限公司泉州分公司", "check_user_kd":"0", "create_time":"2021-04-15 12:03:48", "wdr":"小五义"},
                            {"xjdh":"X1003", "dyw_xh":"D1001", "xjr":"王五", "dyw_add":"1、住宅/南安中骏四季康城（三期）/7号楼/17/1702/142平方米/已满2年", "jgmc":"中国建设银行股份有限公司泉州分公司", "check_user_kd":"1", "create_time":"2021-04-15 12:03:48", "wdr":"阮经天"},
                            {"xjdh":"X1004", "dyw_xh":"D1001", "xjr":"赵六", "dyw_add":"1、住宅/晋江宝龙城市广场（四期）/8号楼/25/2501/140平方米/已满2年", "jgmc":"中国建设银行股份有限公司泉州分公司", "check_user_kd":"0", "create_time":"2021-04-15 12:03:48", "wdr":"宋公明"},
                        ]
                    }

                    resolve(json);  // 成功，使用resolve()返回所有数据
                    // reject('ERROR，连接错误！'); // 错误，使用reject返回错误信息

                }, 100)
                
                // ·后台返回 edit 20210515-1
                /*
                //START AJAX
                var json = {}
                var isHoldOn = true;
                ajax({
                    heading: "获取聊天消息数据",
                    debug: false,
                    async: true, // false 同步取数, true 异步取数. !!!注意：请使用异步取数,否则将出现阻塞线程使系统卡顿的情况
                    url: "../kp_sj/fwh_pub/jk_pic_chat.ashx",
                    data: {
                        "action": "sel_v2_xjd_chat_msgs_lssj",
                        "user": "<%=s_user%>",
                        "sjk": "<%=s_sjk%>",
                        "sjlb": ls_sjlb,
                        "rw_jc": g_rw_jc,
                        "bank_bh": g_bank_bh,
                        "xjdh": g_xjdh,
                        "xjr": g_xjr,
                        "dyw": g_dyw,
                        "ksrq": g_ksrq,
                        "jsrq": g_jsrq,
                        "open_page_num": ls_open_page_num, // 当前页码
                        "every_page_count": ls_every_page_count // 每页记录数
                    },
                    success: function(res){
                        if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                        // if(res == '') return '';
                        json = JSON.parse(res);
                        resolve(json); // 成功，使用resolve()返回所有数据
                    },
                    error: function(res){
                        if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                        reject('ERROR，连接错误！'); // 错误，使用reject返回错误信息
                    },
                    beforeSend: function(XMLHttpRequest){ },
                    complete: function(XMLHttpRequest, textStatus){ }
                })
                if(!isHoldOn){
                    return {}
                }
                //END AJAX
                */
            })
        }

        


        /**
         * 获取机构分行(上级机构)、获取行别统计信息 add 20210515-1
         * @returns {object} 返回数组对象
         */
         function get_data_branch(){
            // 后台返回
            var json = {
                "return":"ok", "data":[
                    {"rw_jc":"民生银行", "sl":"10"},
                    {"rw_jc":"建设银行", "sl":"25"},
                    {"rw_jc":"邮政储蓄", "sl":"35"},
                    {"rw_jc":"工商银行", "sl":"45"},
                    {"rw_jc":"农业银行", "sl":"55"}
                ]
            }
            /*
            //START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取行别统计信息",
                debug: false,
                type: "POST",
                url: "../kp_sj/fwh_pub/jk_pic_chat.ashx",
                data: {
                    "action": "sel_v2_xjd_chat_msgs_rw_jc_tj",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk%>"
                },
                success: function(res){
                    if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    // if(res == '') return '';
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            //END AJAX
            */
            return json;
        }


        /**
         * 获取机构支行(下级机构)、获取银行统计信息 add 20210515-1
         * @param {string} ps_rw_jc 上级机构名称
         * @returns {object} 返回数组对象
         */
         function get_data_subBranch(ps_rw_jc){
            // 后台返回
            var json = {
                "return":"ok", "data":[
                    {"bank_bh":"B1001", "bank_mc":"民生银行田安路支行", "sl":"5"},
                    {"bank_bh":"B1002", "bank_mc":"民生银行陈埭支行", "sl":"10"},
                    {"bank_bh":"B1003", "bank_mc":"民生银行田桥南小微支行", "sl":"15"},
                    {"bank_bh":"B1004", "bank_mc":"民生银行泉州清濛支行", "sl":"20"},
                    {"bank_bh":"B1005", "bank_mc":"民生银行梅岭社区支行", "sl":"25"}
                ]
            }

            /*
            //START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取银行统计信息",
                debug: false,
                type: "POST",
                url: "../kp_sj/fwh_pub/jk_pic_chat.ashx",
                data: {
                    "action": "sel_v2_xjd_chat_msgs_bank_tj",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk%>",
                    "rw_jc": ps_rw_jc
                },
                success: function(res){
                    if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    // if(res == '') return '';
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            //END AJAX
            */
            return json;
        }



        /**
         * 获取行别下拉数据(银行大类、分行) add 20210515-1
         * @param {string} ps_all_text 为数据源自动添加某一项时的文字(可选).eg. '全部' 将为数据源自动添加一个“全部”的项
         * @returns {object} 返回数组对象
         */
        function get_data_hangbie(ps_all_text){
            // 后台返回 (没有"return":"ok")
            var json = {
                "data":[
                    {"rw_jc":"民生银行"},
                    {"rw_jc":"建设银行"},
                    {"rw_jc":"邮政储蓄"},
                    {"rw_jc":"工商银行"},
                    {"rw_jc":"农业银行"}
                ]
            }
            /*
            //START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取行别下拉数据",
                debug: false,
                url: "../kp_sj/fwh_pub/jk_xjsl.ashx",
                data: {
                    "action": "sel_v2_pub_pggs_user_bank_hb_xl",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk%>",
                    "pggs_bh": "<%=s_pggs_bh%>"
                },
                success: function(res){
                    // if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    if(res == '') return '';
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            //END AJAX
            */

            var newJson = {data:[]}
            // 为数据源自动添加一项
            if(typeof ps_all_text != 'undefined'){
                if(ps_all_text != ''){
                    newJson.data.push({"rw_jc":ps_all_text});
                    $.each(json.data, function(i, items){
                        newJson.data.push(items);
                    })
                }
            }else{
                newJson = json;
            }

            return newJson;
        }


        /**
         * 获取银行下拉数据(银行小类、支行) add 20210515-1
         * @param {string} ps_rw_jc 行别
         * @param {string} ps_all_text 为数据源自动添加某一项时的文字(可选).eg. '全部' 将为数据源自动添加一个“全部”的项
         * @returns {object} 返回数组对象
         */
         function get_data_bank(ps_rw_jc, ps_all_text){
            // 后台返回 (没有"return":"ok")
            var json = {
                "return":"ok", "data":[
                    {"bank_bh":"B1001", "bank_mc":"民生银行田安路支行"},
                    {"bank_bh":"B1002", "bank_mc":"民生银行陈埭支行",},
                    {"bank_bh":"B1003", "bank_mc":"民生银行田桥南小微支行"},
                    {"bank_bh":"B1004", "bank_mc":"民生银行泉州清濛支行"},
                    {"bank_bh":"B1005", "bank_mc":"民生银行梅岭社区支行"}
                ]
            }

            /*
            //START AJAX
            var json = {}
            var isHoldOn = true;
            ajax({
                heading: "获取银行下拉数据",
                debug: false,
                url: "../kp_sj/fwh_pub/jk_xjsl.ashx",
                data: {
                    "action": "sel_v2_pub_pggs_user_bank_xl",
                    "user": "<%=s_user%>",
                    "sjk": "<%=s_sjk%>",
                    "pggs_bh": "<%=s_pggs_bh%>",
                    "rw_jc": ps_rw_jc
                },
                success: function(res){
                    // if(toolTip.mistakeTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                    if(res == '') return '';
                    json = JSON.parse(res);
                },
                error: function(res){
                    if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                },
                beforeSend: function(XMLHttpRequest){ },
                complete: function(XMLHttpRequest, textStatus){ }
            })
            if(!isHoldOn){
                return {}
            }
            //END AJAX
            */

            var newJson = {data:[]}
            // 为数据源自动添加一项
            if(typeof ps_all_text != 'undefined'){
                if(ps_all_text != ''){
                    newJson.data.push({"bank_bh":"全部", "bank_mc":"全部"});
                    $.each(json.data, function(i, items){
                        newJson.data.push(items);
                    })
                }
            }else{
                newJson = json;
            }

            return newJson;
        }



        //========================================
        /**
         * 获取机构表单HTML(筛选搜索时) add 20210518-1 20210518-2 20210518-3
         * @param {object} ps_source 数据源
         * @param {object} ps_opts 其它参数组成的对象
         * @returns {HTML} 返回HTML字符串
         */
        function get_org_html(ps_source, ps_opts){
            var defaults = {
                subordinate: false, // 是否下级机构. true 上级机构, false 下级机构
                orgName: '' // 机构名称(可选)
            }
            var settings = $.extend(true, {}, defaults, ps_opts || {})
            var isSubordinate = settings.subordinate ? true : false;
            var orgName = settings.orgName;
            var _rowClassName = isSubordinate ? ' searchBank__sub__one' : ' searchBank__super__one';
            var ls_no_data_tips = isSubordinate ? '对不起，暂无' + orgName + '下级机构数据' : '对不起，暂无机构数据';
            var _html = '<div class="block__searchBank">';
            if(checker.checkJsonHasData(ps_source)){
                $.each(ps_source.data, function(i, items){
                    var ls_bank_bh = typeof items["bank_bh"] == 'undefined' ? '' : items["bank_bh"];
                    var ls_bank_mc = typeof items["bank_mc"] == 'undefined' ? items["rw_jc"] : items["bank_mc"];
                    _html += [
                            '<div class="searchBank__one' + _rowClassName + ' flex" data-bank-bh="' + ls_bank_bh + '">',
                                '<div class="searchBank__text"><span class="searchBank__name">' + ls_bank_mc + '</span><em class="searchBank__message">(' + items["sl"] + ')</em></div>',
                                '<div class="searchBank__operate">',
                                    '<button type="button" class="ne-btn only-text btn-view-unread"><i class="fa fa-search"></i>查看消息</button>',
                                    '<button type="button" class="ne-btn only-text btn-set-read"><i class="fa fa-cog"></i>全部已读</button>',
                                    ( isSubordinate ? '' : '<button type="button" class="ne-btn only-text btn-view-sub"><i class="fa fa-bank"></i>查看支行</button>' ),
                                '</div>',
                            '</div>'
                    ].join('\r\n');
                })
            }else{
                _html += '<div class="panel__nodata">' + ls_no_data_tips + '</div>';
            }
            _html += '</div><!--/.block__searchBank-->';
            return _html;
        }


        /**
         * 创建聊天消息列表 edit 20210527-1
         * @param {object} ps_source 数据源
         * @param {object} ps_params 当前页码等组成的一维对象
         */
        function create_list_message(ps_source, ps_params){
            var parameter = typeof ps_params == 'undefined' ? {} : ps_params;
            var nowpage = typeof parameter.curpage == 'undefined' ? 1 : (parameter.curpage == '' ? 1 : parameter.curpage); // !!!页码标记
            var node = ROOTNODE;
            var _html = '';
            $.each(ps_source.data, function(i, items){
                var ls_xuhao = (nowpage - 1) * PAGESIZE + (i + 1);
                // “未读人”一栏显示隐藏
                var ls_wdr = items["wdr"];
                var _unreadRowStyle = '';
                if(TABINDEX == 3){ // 只有[未回复消息]切片时才显示
                    if(ls_wdr.toString().replace(/([ ]+)/g, '') != '') _unreadRowStyle = ''; // 只有字段值非空时才显示
                    else _unreadRowStyle = ' style="display: none"';
                }else{
                    _unreadRowStyle = ' style="display: none"';
                }
                // 拼接
                _html += [
                    '<div class="history__one">',
                        '<div class="eform-order">' + ls_xuhao + '</div>',
                        '<div class="eform-content">',
                            '<div class="eform-row">',
                                '<div class="item-l"><label>询价单号：</label></div>',
                                '<div class="item-r"><span>' + items["xjdh"] + '</span></div>',
                            '</div>',
                            '<div class="eform-row flex-start">',
                                '<div class="item-l"><label>抵押物：</label></div>',
                                '<div class="item-r"><span>' + items["dyw_add"] + '</span></div>',
                            '</div>',
                            '<div class="eform-row">',
                                '<div class="item-l"><label>询价人：</label></div>',
                                '<div class="item-r"><span>' + items["xjr"] + '</span></div>',
                            '</div>',
                            '<div class="eform-row flex-start">',
                                '<div class="item-l"><label>机构名称：</label></div>',
                                '<div class="item-r"><span>' + items["jgmc"] + '</span></div>',
                            '</div>',
                            '<div class="eform-row">',
                                '<div class="item-l"><label>创建时间：</label></div>',
                                '<div class="item-r"><span>' + items["create_time"] + '</span></div>',
                            '</div>',
                            '<div class="eform-row row__unreadPerson"' + _unreadRowStyle + '>',
                                '<div class="item-l"><label>未读人：</label></div>',
                                '<div class="item-r"><span>' + ls_wdr + '</span></div>',
                            '</div>',
                        '</div><!--/.eform-content-->',
                        '<div class="eform-button child-w-100 child-no-border" data-xjdh="' + items["xjdh"] + '" data-dyw-xh="' + items["dyw_xh"] + '" data-check-user-kd="' + items["check_user_kd"] + '">',
                            '<button type="button" class="ne-btn only-text btn-view"><span>查看</span><i class="fa fa-chevron-right"></i></button>',
                        '</div><!--/.eform-button-->',
                    '</div><!--/.history__one-->'
                ].join('\r\n');
            })
            if($(node).length > 0){
                $(node).append(_html);
            }
        }

        
        /**
         * 根据是否评估公司人员及切片显示或隐藏搜索区域 add 20210517-1
         */
        function displayOrHideSearch(ps_tab_index){
            if(ps_tab_index == 1){ // “我的未读消息”切片时
                if(g_pggs_bh != '') // 评估公司人员时才显示搜索区域
                    $('.search').show();
                else
                    $('.search').hide();
            }
            else{ // “最近消息”、“未回复消息”切片时总是显示搜索区域
                $('.search').show();
            }
        }



        /**
         * 加载数据 edit 20210422-1
         */
        function load_data(){
            neui.showAnimate();
            setTimeout(function(){
                // 调用上拉加载更多
                var node = ROOTNODE;
                $(node).neuiLoadmore({
                    scrollArea: window,
                    scrollHeight: 0,
                    autoLoad: true,
                    cleanUp: true,
                    pagesize: PAGESIZE,
                    threshold: 50,
                    distance: 50,
                    delay: 100,
                    labelDown: {
                        more: '↑上拉加载更多',
                        load: '加载中',
                        empty: '没有更多了'
                    },
                    getData: function(e){
                        // console.log('当前页码：', e.curpage)
                        return get_data_message(e.curpage)
                    },
                    loadDownFn: function (e) {
                        create_list_message(e.source, {curpage: e.curpage})
                    }
                })
                neui.destroyAnimate();
            }, 100)
        }



        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        $(function(){

            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //                                                   初始化
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //——————————————————————————————————————————
            //=====控制区域显示隐藏 edit 20210517-1
            // 选项卡显示或隐藏
            if(g_check_manager == '1'){ // 管理员时
                $('.tab__latest, .tab__unreply').show(); // 显示[最近消息][未回复消息]切片
                $('.tab__latest').addClass('has-border');
            }
            // 搜索区域显示或隐藏
            displayOrHideSearch(TABINDEX);
            // 判断区域显示或隐藏,改变界面外观 edit 20210518-1
            var tabShowCount = 0; // 处于显示状态的切片数量,默认0
            $('.tab').children().each(function(){
                if($(this).is(':visible')) tabShowCount++;
            })
            if(tabShowCount == 1){ // 仅有一个切片显示时
                $('.tab').children().each(function(){
                    if($(this).is(':visible')) $(this).css({
                        width: '100%',
                        border: '1px solid #f5f5f5'
                    })
                })
            }
             


            //——————————————————————————————————————————
            //=====初始化加载数据
            load_data();



            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //                                                   系列事件
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //——————————————————————————————————————————
            //=====选项卡切换事件 edit 20210517-1
            $('.tab div').on('click', function(){
                $(this).addClass('on').siblings().removeClass('on');
                var index = $(this).index() + 1;
                //console.log("index：", index)
                displayOrHideSearch(index); // 搜索区域显示或隐藏
                TABINDEX = index;  // 全局赋值
                load_data(); // 重载数据
            });


            //——————————————————————————————————————————
            //=====查看按钮、查看聊天消息按钮  edit 20211013-1
            $(ROOTNODE).on('click', '.btn-view', function(){
                var eleParent = $(this).parent();
                var ls_xjdh = eleParent.attr('data-xjdh'),
                    ls_dyw_xh = eleParent.attr('data-dyw-xh'),
                    ls_check_user_kd = eleParent.attr('data-check-user-kd');
                var arr = [ ls_xjdh, ls_dyw_xh, ls_check_user_kd ]
                // console.log('数组arr：', arr);
                // 跳转链接
                var linkUrl = '../inquiry/wyxj-我要询价v2.0-惠安农信社.html'; // ajax({})
                window.location.href = linkUrl + '?x=' + ls_xjdh + '&d=' + ls_dyw_xh + '&k=' + ls_check_user_kd + '&chat=1'; // ajax({})
            });



           
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //                                                   搜索区域系列事件
            //————————————————————————————————————————————————————————————————————————————————————————————————————————————————
            //————————————————————————————————
            //=====设置窗口大小 add 20211013-1
            var offset = {
                left: !checker.checkIsMobile() ? ($(window).width() - 600) / 2 : 0,
                right: !checker.checkIsMobile() ? ($(window).width() - 600) / 2 : 0
            }



            //——————————————————————————————————————————
            //=====筛选按钮 add 20210515-1
            var _topHtml = '注：<em>红色数字</em>表示未读消息数量'; // edit 20210518-1
            $('#btn-filter').on('click', function(){
                var caption = $('.tab').children().eq(TABINDEX - 1).text();
                if(TABINDEX == 1){ // “我的未读消息”切片查询
                    neui.showAnimate();
                    setTimeout(function(){
                        
                        var branchJson = get_data_branch();
                        var _conHtml = get_org_html(branchJson);
                        neui.openAside({
                            caption: '我的未读消息(全部机构)',
                            toper: _topHtml,
                            content: _conHtml,
                            cross: false,
                            back: true,
                            showBackText: true,
                            capLine: true,
                            capShadow: true,
                            buttons: [],
                            offset: offset, // edit 20211013-1
                            openCallBack: function(e){
                                e.eleTop.find('.lay-header-custom').css({
                                    fontSize: '14px'
                                }).find('em').css({
                                    color: '#ff0000'
                                })
                            },
                            btnCallBack: function(ret, e){ } 
                        })
                        
                        neui.destroyAnimate();
                    }, 100)
                }
             
                else{ // “最近消息”、“未回复消息”切片查询
                    var _conHtml = neuiSearchBox.getForm({
                        enableLocale: false, //是否启用本地演示数据源. true 是(默认), false 否
                        source: [  //自定义数据源
                            {type:"input", label:"行别", name:"s-category", value:g_rw_jc, placeholder:"请选择" , readonly:true},
                            {type:"textarea", label:"银行名称", name:"s-bank", value:g_bank_mc, placeholder:"请先选择行别", readonly:true},
                            {type:"input", label:"询价单号", name:"s-oddNumber", value:g_xjdh, placeholder:"输入询价单号"},
                            {type:"input", label:"询价人", name:"s-quiryer", value:g_xjr, placeholder:"输入询价人"},
                            {type:"textarea", label:"抵押物", name:"s-pawn", value:g_dyw, placeholder:"输入楼盘名称、幢号、楼层等抵押物信息"},
                            {type:"input", label:"时间", "group": [
                                {label:"自", name:"s-startDate", class:"nedate", value:g_ksrq, placeholder:"开始日期", readonly: true},
                                {label:"至", name:"s-endDate", class:"nedate", value:g_jsrq, placeholder:"结束日期", readonly: true}
                            ]}
                        ]
                    })

                    neui.openAside({
                        caption: caption,
                        content: _conHtml,
                        cross: false,
                        back: true,
                        showBackText: true,
                        capLine: true,
                        capShadow: true,
                        buttons: [ // 按钮(可选)
                            {text: "重置", name: "btn-reset", width: "30%", class: "ne-btn", backColor: "", foreColor: "", radius: "0"},
                            {text: "查询", name: "btn-query", width: "70%", class: "ne-btn info", backColor: "", foreColor: "", radius: "0"}
                        ],
                        offset: offset, // add 20211013-1
                        openCallBack: function(e){
                            // 加载日历控件
                            $('.nedate').each(function(){
                                neuiCalendar.neDate($(this), {"empty":true});
                            })
                        },
                        btnCallBack: function(ret, e){
                            // console.log('e：', e)
                            var self = this;
                            if(ret == 1){ // 重置按钮
                                var eleTextBox =  e.eleMain.find('input:text, textarea');
                                neui.showAnimate();
                                setTimeout(function(){
                                    eleTextBox.val('');
                                    if(typeof eleTextBox.attr('data-bh') != 'undefined') eleTextBox.attr('data-bh', '');
                                    neui.destroyAnimate();
                                }, 100)
                            }
                            if(ret == 2){ // 查询按钮
                                // 全局赋值
                                g_rw_jc = filter.html($('#s-category').val());
                                g_bank_bh = filter.html($('#s-bank').attr('data-bh'));
                                if(typeof g_bank_bh == 'undefined') g_bank_bh = '';
                                g_bank_mc = $('#s-bank').val();
                                g_xjdh = filter.html($('#s-oddNumber').val());
                                g_xjr = filter.html($('#s-quiryer').val());
                                g_dyw = filter.html($('#s-pawn').val());
                                g_ksrq = filter.html($('#s-startDate').val());
                                g_jsrq = filter.html($('#s-endDate').val());
                                var arr = [ g_rw_jc, g_bank_bh, g_bank_mc, g_xjdh, g_xjr, g_dyw, g_ksrq, g_jsrq ]
                                // console.log('查询数组：', arr);
    
                                load_data(); // 重载数据
                                self.closeAside(); // 关闭当前窗口

                            }
                        } 
                    })
                }
            });

            

            //——————————————————————————————————————————
            //===== “我的未读消息”[筛选弹出窗口]
            // 查看支行按钮 add 20210518-3
            $(document).on('click', '.btn-view-sub', function(e){
                e.stopPropagation();
                var $parent = $(this).parents('.searchBank__one');
                var ls_bank_bh = $parent.attr('data-bank-bh'),
                    ls_bank_mc = $parent.find('.searchBank__name').text();
                // alert('银行编号：' + ls_bank_bh + '\n银行名称：' + ls_bank_mc);
                neui.showAnimate();
                setTimeout(function(){
                    var subBranchJson = get_data_subBranch(ls_bank_mc);
                    var _conHtml = get_org_html(subBranchJson, {subordinate: true, orgName: ls_bank_mc}); // edit 20210518-1
                    neui.openAside({
                        caption: '我的未读消息(' + ls_bank_mc + ')',
                        toper: _topHtml,
                        content: _conHtml,
                        cross: false,
                        back: true,
                        showBackText: true,
                        capLine: true,
                        capShadow: true,
                        buttons: [],
                        offset: offset, // edit 20211013-1
                        openCallBack: function(e){
                            e.eleTop.find('.lay-header-custom').css({
                                fontSize: '14px'
                            }).find('em').css({
                                color: '#ff0000'
                            })
                        },
                        btnCallBack: function(ret, e){ } 
                    })

                    neui.destroyAnimate();
                }, 100)
            });



            //——————————————————————————————————————————
            //=====“我的未读消息”[筛选弹出窗口]
            // 查看消息按钮 edit 20210526-1
            $(document).on('click', '.btn-view-unread', function(){
                var $parent = $(this).parents('.searchBank__one');
                var ls_bank_bh = $parent.attr('data-bank-bh');
                var ls_bank_mc = $parent.find('.searchBank__name').text();
                // alert('银行编号：' + ls_bank_bh + '\n银行名称：' + ls_bank_mc);
                if($parent[0].className.indexOf('searchBank__super__one') > -1){ // 分行(上级机构),只需要行别
                    // 全局赋值
                    g_bank_bh = '';
                    g_rw_jc = ls_bank_mc;
                }else{ // 支行(下级机构),只需要银行编号
                    // 全局赋值
                    g_bank_bh = ls_bank_bh;
                    g_rw_jc = '';
                }
                $('.ne-aside').remove(); // 关闭所有窗口
                $('html').removeClass('ne-noscroll'); // 解除禁止滚动
                load_data(); // 重载数据
            });
         
            


            //——————————————————————————————————————————
            //===== “我的未读消息”[筛选弹出窗口]
            // 行别统计信息：标记为全部已读按钮 add 20210515-1
            $(document).on('click', '.searchBank__super__one .btn-set-read', function(e){
                e.stopPropagation();
                var $this = $(this);
                var ls_rw_jc = $(this).parents('.searchBank__one').find('.searchBank__name').text();
                // alert(ls_rw_jc)
                //开始执行
                neuiDialog.alert({
                    animate: true,
                    caption: '提示',
                    message: '确认标记为全部已读？',
                    buttons: ['确定', '取消'],
                    callBack: function(ret){
                        if(ret == 1){
                            var flag = '', msg = '操作成功';
                            neui.showAnimate();
                            setTimeout(function(){
                                //后台返回
                                /*
                                //START AJAX
                                var isHoldOn = true;
                                ajax({
                                    heading: "行别统计信息标记为已读",
                                    debug: false,
                                    type: "POST",
                                    url: "../kp_sj/fwh_pub/jk_pic_chat.ashx",
                                    data: {
                                        "action": "del_v2_xjd_chat_msgs_rw_jc",
                                        "user": "<%=s_user%>",
                                        "sjk": "<%=s_sjk%>",
                                        "rw_jc": ls_rw_jc
                                    },
                                    success: function(res){
                                        if(toolTip.emptyTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                                        var json = JSON.parse(res);
                                        flag = json.return == 'ok' ? 1 : 0;
                                        if(!flag) msg = json.data;
                                    },
                                    error: function(res){
                                        if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                                    },
                                    beforeSend: function(XMLHttpRequest){ },
                                    complete: function(XMLHttpRequest, textStatus){ }
                                })
                                if(!isHoldOn){
                                    neui.destroyAnimate();
                                    return;
                                }
                                //END AJAX
                                */
                                flag = parseInt(1); //1 成功, 0 失败
                                if(!flag) msg = '操作失败';

                                neuiDialog.alert({
                                    caption: '提示',
                                    message: msg,
                                    buttons: ['确定'],
                                    callBack: function(){
                                        if(flag){ //成功
                                            $this.parent().siblings().find('.searchBank__message').text('(0)'); // 未读消息清
                                        }
                                    }
                                })

                                neui.destroyAnimate();
                            }, 100)
                        }
                    }
                })
            });



             //——————————————————————————————————————————
            //=====“我的未读消息”[筛选弹出窗口]
            // 银行统计信息：标记为全部已读按钮 add 20210515-1
            $(document).on('click', '.searchBank__sub__one .btn-set-read', function(e){
                e.stopPropagation();
                var $this = $(this);
                var ls_bank_bh = $(this).parents('.searchBank__one').attr('data-bank-bh');
                // alert(ls_bank_bh)
                //开始执行
                neuiDialog.alert({
                    animate: true,
                    caption: '提示',
                    message: '确认标记为全部已读？',
                    buttons: ['确定', '取消'],
                    callBack: function(ret){
                        if(ret == 1){
                            var flag = '', msg = '操作成功';
                            neui.showAnimate();
                            setTimeout(function(){
                                //后台返回
                                /*
                                //START AJAX
                                var isHoldOn = true;
                                ajax({
                                    heading: "银行统计信息标记为已读",
                                    debug: false,
                                    type: "POST",
                                    url: "../kp_sj/fwh_pub/jk_pic_chat.ashx",
                                    data: {
                                        "action": "del_v2_xjd_chat_msgs_bank",
                                        "user": "<%=s_user%>",
                                        "sjk": "<%=s_sjk%>",
                                        "bank_bh": ls_bank_bh
                                    },
                                    success: function(res){
                                        if(toolTip.emptyTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                                        var json = JSON.parse(res);
                                        flag = json.return == 'ok' ? 1 : 0;
                                        if(!flag) msg = json.data;
                                    },
                                    error: function(res){
                                        if(toolTip.wrongTips(res, this.url, this.heading, this.debug)) { isHoldOn = false; return; }
                                    },
                                    beforeSend: function(XMLHttpRequest){ },
                                    complete: function(XMLHttpRequest, textStatus){ }
                                })
                                if(!isHoldOn){
                                    neui.destroyAnimate();
                                    return;
                                }
                                //END AJAX
                                */
                                flag = parseInt(1); //1 成功, 0 失败
                                if(!flag) msg = '操作失败';

                                neuiDialog.alert({
                                    caption: '提示',
                                    message: msg,
                                    buttons: ['确定'],
                                    callBack: function(){
                                        if(flag){ //成功
                                            $this.parent().siblings().find('.searchBank__message').text('(0)'); // 未读消息清
                                        }
                                    }
                                })

                                neui.destroyAnimate();
                            }, 100)
                        }
                    }
                })
            });




            //——————————————————————————————————————————
            //=====“最近消息”、“未回复消息”[筛选弹出窗口]
            // 行别下拉 edit 20211013-2
            $(document).on('click', '#s-category', function(){
                var $this = $(this);
                var hangbieJson = get_data_hangbie();
                if($.isEmptyObject(hangbieJson) || hangbieJson.data.length == 0){
                    meuiDialog.alert({
                        caption: '提示',
                        message: '暂无行别数据',
                        buttons: ['确定']
                    })
                    return;
                }
                neuiDropdown({
					json: hangbieJson,
					format: ['rw_jc']
				}, $this)
            });


            //——————————————————————————————————————————
            //=====“最近消息”、“未回复消息”[筛选弹出窗口]
            // 银行名称下拉 edit 20211013-2
            $(document).on('click', '#s-bank', function(){
                var $this = $(this);
                var ls_rw_jc = filter.html($('#s-category').val());
                // alert(ls_rw_jc);
                if(ls_rw_jc == defaultCateMc) ls_rw_jc = ''; // 行别为全部时转成空值
                var bankJson = get_data_bank(ls_rw_jc);
                if($.isEmptyObject(bankJson) || bankJson.data.length == 0){
                    meuiDialog.alert({
                        caption: '提示',
                        message: '暂无银行数据',
                        buttons: ['确定']
                    })
                    return;
                }

                neuiDropdown({
					json: bankJson,
					format: ["bank_bh", "bank_mc"],
				}, $this)
            });




            
        }); //$(function(){})
    </script>
</body>
</html>